# 01 - Generate and verify SLSA provenance

## Highlight

Let's start by familiarizing ourselves with the goal of this activity.

### Attacks prevented

Building with a high-level SLSA builder prevents [build threats (E) "compromise build process"](https://slsa.dev/spec/v1.0/threats), i.e., it prevents a build process compromise from infecting different builds. SLSA builders mitigates the threat by running each build process in an isolated, ephemeral environment. Beware of [dependency caching](https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows) in your build, since those may violate this property.

### What you will need

Install the [necessary software](https://github.com/lmrs2/bh-aisec/blob/main/INSTALLATION.md).

### Provenance generation

SLSA provenance is generated by a builder. In this activity, we will use [SLSA GitHub generator](https://github.com/slsa-framework/slsa-github-generator) project. As described in the project's [README](https://github.com/slsa-framework/slsa-github-generator?tab=readme-ov-file#generate-provenance), the project offers builders for [various ecosystems](https://github.com/slsa-framework/slsa-github-generator?tab=readme-ov-file#builders). The project also support so-called "[generators](https://github.com/slsa-framework/slsa-github-generator?tab=readme-ov-file#generators)" which only generate provenance without changing your build definition. In a nutshell, you will build your container as you always do and simply call the generator at the end your workflow to generate the provenance. In this activity, we will use the [container generator](https://github.com/slsa-framework/slsa-github-generator/blob/main/internal/builders/container/README.md).

### Provenance verification

To verify the provenance, we will use the [slsa-verifier](https://github.com/slsa-framework/slsa-verifier) project. Verifying provenance requires am expected builder and a source repository name.

## Deep dive

### Provenance generation

#### Reading
Read the section [Getting started](https://github.com/slsa-framework/slsa-github-generator/blob/main/internal/builders/container/README.md#getting-started) of the container generator. 

#### Create the workflow

Fork this repository [https://github.com/lmrs2/bh-aisec-project1](https://github.com/lmrs2/bh-aisec-project1) by clicking this [link](https://github.com/lmrs2/bh-aisec-project1/fork). Navigate to the Actions tab and enable worksflows, as depicted in the image below:

![workflow image enable](https://raw.githubusercontent.com/lmrs2/bh-aisec/main/images/enable-workflows.jpg "How to enable workflows in your forked repository")

The repository contains a GitHub workflow [.github/workflow/build-echo-server.yml](https://github.com/lmrs2/bh-aisec-project1/blob/main/.github/workflows/build-echo-server.yml) which builds and generates provenance for a hypothetical server. The file contains the following steps:

1. [Authenticate](https://github.com/lmrs2/bh-aisec-project1/blob/main/.github/workflows/build-echo-server.yml#L33-L41) to docker registry.
1. [Build the container and push it to docker registry as "\<repository-name\>-echo-server"](https://github.com/lmrs2/bh-aisec-project1/blob/main/.github/workflows/build-echo-server.yml#L49-L56). The image name is configured via an [environment variable at the top of the workflow](https://github.com/lmrs2/bh-aisec-project1/blob/main/.github/workflows/build-echo-server.yml#L14). The container code is stored in this repository under directory [images/echo-server/](https://github.com/lmrs2/bh-aisec-project1/blob/main/images/echo-server) and is a simple echo server.
1. In a seperate job, we [call the container generator](https://github.com/lmrs2/bh-aisec-project1/blob/main/.github/workflows/build-echo-server.yml#L64-L79) with the image name and digest. Note that is is IMPORTANT for the digest to be computed _without_ pulling the image from the registry, because an attacker / insider _could_ push a malicious image between our workflow push and pull.
1. As a sanity step, we [pull the container and run it](https://github.com/lmrs2/bh-aisec-project1/blob/main/.github/workflows/build-echo-server.yml#L81-L102).

#### Run the workflow

Follow these steps:

1. Update the [REGISTRY_USERNAME](https://github.com/lmrs2/bh-aisec-project1/blob/main/.github/workflows/build-echo-server.yml#L15) to your own docker registry username.
1. Update the [hardcoded username ](https://github.com/lmrs2/bh-aisec-project1/blob/main/.github/workflows/build-echo-server.yml#L75) used to store the provenance to registtry.
1. Create a [docker regitry token](https://docs.docker.com/security/for-developers/access-tokens/#create-an-access-token) with read, write and delete access.
2. Store your docker token as a new GitHub repository secret called `REGISTRY_PASSWORD`: [Settings > New repository secret](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository).
2. Run the workflow via the [GitHub UI](https://docs.github.com/en/actions/using-workflows/manually-running-a-workflow#running-a-workflow). It will take ~2mn to complete. If all goes well, the workflow run will display a green icon. Click on the job run called "run" sttept "Run it" (see [example run](https://github.com/lmrs2/bh-aisec-project1/actions/runs/15938669578/job/44963419298)). Note the name of the container displayed in the logs. In the example above, it is `docker.io/lmrs2/bh-aisec-project1-echo-server@sha256:7e0c03e174f7f64ab5c4a1ce9cabd3e01d017d73a802597ad2b4da8f846e6a58`.


#### Verify provenance

Install the [slsa-verifier](https://github.com/slsa-framework/oss-na24-slsa-workshop/blob/main/INSTALLATION.md#slsa-verifier).

Make sure you have access to your image by authenticating to docker:

```shell
$ REGISTRY_TOKEN=<your-token>
$ REGISTRY_USERNAME=<registry-username>
$ docker login -u "${REGISTRY_USERNAME}" "${REGISTRY_TOKEN}"
```

To verify your container, use the following command:

```shell
# Update the image as recorded in your logs. You will sit it printed under the "run" build.
$ image=docker.io/lmrs2/bh-aisec-project1-echo-server@sha256:7e0c03e174f7f64ab5c4a1ce9cabd3e01d017d73a802597ad2b4da8f846e6a58
# Replace with your own repository.
$ source_uri=github.com/lmrs2/bh-aisec-project1
$ path/to/slsa-verifier verify-image "${image}" --source-uri "${source_uri}" --builder-id=https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml
```

The slsa-verifier verifies:

1. The cryptographic digest of the container matches the one in the attestation
2. The source origin of the repository
3. The builder who built and generated the attestation.

Pass command `--print-provenance | jq` to see the verified content of the attestation.

Explore other commands by using the `--help` command. You can read more on the [project repository](https://github.com/slsa-framework/slsa-verifier).

Run the same verification command but remove the `sha256:xxx` part of the image name: `image=idocker.io/lmrs2/bh-aisec-project1-echo-server`. Why is this failing? See [hints](https://github.com/slsa-framework/slsa-verifier/tree/main?tab=readme-ov-file#toctou-attacks).

#### Optional: Verification in a GitHub  workflow

Add a job to your workflow and verify its provenance in the workflow. You can install the slsa-verifier as a step in your workflow with its [GitHub Action](https://github.com/slsa-framework/slsa-verifier/blob/main/actions/installer/README.md).

Read about the [limitations](https://github.com/slsa-framework/slsa-github-generator/issues/1868) of the current implementation of the generators.

## Take the quizz!

After completing this activity, you should be able to answer the following questions:

1. What is a SLSA builder?
2. What is a SLSA level? What does it represent? What component do we associate it to?
3. What is SLSA provenance? What information does it contain?
4. What is the necessary metadata to verify SLSA provenance for an artifact?
5. Read about [dependency caching](https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows). How might it impact the security of your builds?
6. Read about [GitHub artifacts](https://docs.github.com/en/actions/how-tos/writing-workflows/choosing-what-your-workflow-does/storing-and-sharing-data-from-a-workflow). How might it impact the security of your builds?