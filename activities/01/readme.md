# 01 - Generate and verify SLSA provenance

## Highlight

Let's start by familiarizing ourselves with the goal of this activity.

### What you will need

To complete this activity, you need:

1. A GitHub account
1. A docker registry account (alternatively you can use GitHub registry)

### Provenance generation

SLSA provenance is generated by a builder. In this activity, we will use [SLSA GitHub generator](https://github.com/slsa-framework/slsa-github-generator) project. As described in the project's [README](https://github.com/slsa-framework/slsa-github-generator?tab=readme-ov-file#generate-provenance), the project offers builders for [various ecosystems](https://github.com/slsa-framework/slsa-github-generator?tab=readme-ov-file#builders). The project also support so-called "[generators](https://github.com/slsa-framework/slsa-github-generator?tab=readme-ov-file#generators)" which only generate provenance without changing your build definition. In a nutshell, you will build your container as you always do and simply call the generator at the end your workflow to generate the provenance. In this activity, we will use the [container generator](https://github.com/slsa-framework/slsa-github-generator/blob/main/internal/builders/container/README.md).

### Provenance verification

To verify the provenance, we will use the [slsa-verifier](https://github.com/slsa-framework/slsa-verifier) project. Verifying provenance requires a builder and a source repository.

## Deep dive

### Provenance generation

#### Reading
Read the section [Getting started](https://github.com/slsa-framework/slsa-github-generator/blob/main/internal/builders/container/README.md#getting-started) of the container generator. 

#### Create the workflow

Fork this repository [https://github.com/laurentsimon/oss-na24-slsa-workshop-project1](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1) by clicking this [link](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1/fork).

The repository contains a GitHub workflow [.github/workflow/build-echo-server.yml](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml) which builds and generates provenance for a hypothetical server. The file contains the following steps:

1. Authenticate to docker registry, see [here](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L33-L41).
1. Build the container and push it to docker registry as "<repository-name>-echo-server", see [here](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L49-L56). The image name is configured via an environment variable at the top of the workflow, see [here](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L14). The container code is stored in this repository under [images/echo-server/](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1/blob/main/images/echo-server) and is a simple echo server.
1. In a diffeernt job, we call the container generator with the image name and digest, see [here](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L64-L79). Note that is is IMPORTANT for the digest to be computed _without_ interaction with the registry, because an attacker / insider _could_ push a malicious image between our workflow push and pull.
1. As a sanity step, we pull the container and run it, see [here](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L81-L102).

#### Run the workflow

Follow these steps:

1. You need to update the [REGISTRY_USERNAME](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L15) to your own docker registry username.
1. Create a docker regitry token (with push access), see [here](https://docs.docker.com/security/for-developers/access-tokens/#create-an-access-token). 
2. Store your docker token as a new GitHub repository secret called `REGISTRY_PASSWORD`: [Settings > New repository secret](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository).
2. Run the workflow via the [GitHub UI](https://docs.github.com/en/actions/using-workflows/manually-running-a-workflow#running-a-workflow). It will take ~2mn to complete. If all goes well, the workflow run will display a green icon. Click on the job run called "run" (see example [here](https://github.com/laurentsimon/oss-na24-slsa-workshop-project1/actions/runs/8329542362/job/22792213105)). Note the name of the container displayed in the logs. In the example above, it is `docker.io/laurentsimon/oss-na24-slsa-workshop-project1-echo-server@sha256:3cea74d6b3d033869f4185a9478d66009c97fda18631c0650f7ea3be4fca722c`.


#### Verify provenance

To install slsa-verifier, follow the instructions from [here](https://github.com/slsa-framework/slsa-verifier?tab=readme-ov-file#option-1-install-via-go).

Make sure you have access to your image by authenticating to docker:

```shell
REGISTRY_TOKEN=<your-token>
REGISTRY_USERNAME=<registru-username>
docker login -u "${REGISTRY_USERNAME}" "${REGISTRY_TOKEN}"
```

To verify your container, use the following command:

```shell
# Update the image as recorded in your logs
image=docker.io/laurentsimon/oss-na24-slsa-workshop-project1-echo-server@sha256:3cea74d6b3d033869f4185a9478d66009c97fda18631c0650f7ea3be4fca722c
source_uri=github.com/laurentsimon/oss-na24-slsa-workshop-project1
path/to/slsa-verifier verify-image "${image}" --source-uri "${source_uri}" --builder-id=https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml
```

The slsa-verifier verifies:

1. The cryptographic digest of the container matches the one in the attestation
2. The repository that the container was built was your repoistory.

Pass command `--print-provenance | jq` to see the plaintext intoto attestation.

Explore other commands by using the `--help` command. You cna read more on the project repository.

Run the same verification command but remove the `sha256:xxx` part of the image name: `image=image=docker.io/laurentsimon/oss-na24-slsa-workshop-project1-echo-server`. Why is this failing? See hints [here](https://github.com/slsa-framework/slsa-verifier/tree/main?tab=readme-ov-file#toctou-attacks).

#### Further reading: Verification in a GitHub  workflow

Add a job to your workflow and verify its provenance in the workflow. You can install the slsa-verifier via its [GitHub Action](https://github.com/slsa-framework/slsa-verifier/blob/main/actions/installer/README.md).

Read about the limitation of the current implementation of the generators [here](https://github.com/slsa-framework/slsa-github-generator/issues/1868).